<!DOCTYPE html>
<html lang="ja"><head>
<link href="./favicon.ico" rel="icon">
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/tabby.min.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-html.min.css" rel="stylesheet" data-mode="light">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.3.361">

  <meta name="author" content="Soichi Matsuura">
  <title>プレゼミ講義ノート - プレゼミ2023  第3回 Rの使い方・データ操作・可視化</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #f8f8f2; background-color: #282a36; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #f8f8f2; } /* Normal */
    code span.al { color: #ff5555; font-weight: bold; } /* Alert */
    code span.an { color: #ff79c6; } /* Annotation */
    code span.at { color: #ff79c6; } /* Attribute */
    code span.bn { color: #bd93f9; } /* BaseN */
    code span.bu { color: #8be9fd; } /* BuiltIn */
    code span.cf { color: #ff79c6; } /* ControlFlow */
    code span.ch { color: #f1fa8c; } /* Char */
    code span.cn { color: #bd93f9; font-weight: bold; } /* Constant */
    code span.co { color: #6272a4; } /* Comment */
    code span.cv { color: #8be9fd; } /* CommentVar */
    code span.do { color: #ffb86c; } /* Documentation */
    code span.dt { color: #8be9fd; font-style: italic; } /* DataType */
    code span.dv { color: #bd93f9; } /* DecVal */
    code span.er { color: #ff5555; text-decoration: underline; } /* Error */
    code span.ex { color: #8be9fd; } /* Extension */
    code span.fl { color: #bd93f9; } /* Float */
    code span.fu { color: #50fa7b; } /* Function */
    code span.im { color: #ff79c6; } /* Import */
    code span.in { color: #f1fa8c; } /* Information */
    code span.kw { color: #ff79c6; } /* Keyword */
    code span.op { color: #f8f8f2; } /* Operator */
    code span.ot { color: #50fa7b; } /* Other */
    code span.pp { color: #ff79c6; } /* Preprocessor */
    code span.re { color: #8be9fd; } /* RegionMarker */
    code span.sc { color: #ff79c6; } /* SpecialChar */
    code span.ss { color: #f1fa8c; } /* SpecialString */
    code span.st { color: #f1fa8c; } /* String */
    code span.va { color: #8be9fd; } /* Variable */
    code span.vs { color: #f1fa8c; } /* VerbatimString */
    code span.wa { color: #ff5555; } /* Warning */
  </style>
  <link rel="stylesheet" href="site_libs/revealjs/dist/theme/quarto.css">
  <link href="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    margin-bottom: 0.5rem;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-dark">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title"><p><b>プレゼミ2023</b> <br> <span style="color: #282A36;">第3回 Rの使い方・データ操作・可視化</span></p></h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Soichi Matsuura 
</div>
</div>
</div>

</section>
<section id="本日の講義内容" class="slide level2">
<h2>本日の講義内容</h2>
<p>第3回講義の<strong>到達目標</strong>は、</p>
<ul>
<li>Posit Cloudにログインして、ブラウザ上でRstudioを使うことができる。</li>
<li>Visual Studio CodeでRのソースコードを書くことができる。</li>
<li>Visual Studio CodeでQuartoを使って、レポートや論文を書くことができる。</li>
<li>Rでデータを読み込み，データを加工し，グラフを作ることができる。</li>
</ul>
</section>
<section id="rの基本操作" class="slide level2">
<h2>Rの基本操作</h2>
<p>まずは、<code>1+2</code>を計算してみます。</p>
<div class="columns">
<div class="column" style="width:45%;">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-1_2250db7d734efb7b4c8fbceb6ce8a387">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>と書いて、その行にカーソルがある状態で、<code>Ctrl + Enter</code>を押すと、</p>
</div><div class="column" style="width:10%;">

</div><div class="column" style="width:45%;">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-2_000292199a4c3a17ebb32c8d297c35ad">
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
</div>
<p>という計算結果が表示されます。</p>
</div>
</div>
</section>
<section id="よく使う基本関数" class="slide level2">
<h2>よく使う基本関数</h2>
<ul>
<li><code>+</code>加算，<code>-</code>減算, <code>/</code>除算, <code>*</code>乗算</li>
<li><code>^</code>累乗, 2の2乗は<code>2^2</code></li>
<li><code>sqrt()</code>関数で平方根の計算</li>
<li><code>c()</code>関数でベクトルの作成</li>
<li><code>mean()</code>関数で平均を計算</li>
<li><code>seq()</code>関数で数列の作成</li>
</ul>
</section>
<section id="パッケージ" class="slide level2">
<h2>パッケージ</h2>
<p>Rはパッケージを使って機能を拡張することができます。</p>
<ul>
<li><code>install.packages()</code>関数でパッケージをインストールする。
<ul>
<li>インストールしようとすると，どのサーバーからインストールするのか尋ねられるので，<code>TOKYO</code>のサーバーを選択するようにしましょう。</li>
</ul></li>
<li><code>library()</code>関数でパッケージを読み込む</li>
</ul>
<p><code>install.pacakges()</code>が失敗するときは，RstudioあるいはR本体で<code>install.packages()</code>で実行してみる。</p>
</section>
<section id="tidyverseパッケージ" class="slide level2">
<h2>tidyverseパッケージ</h2>
<p>以下のコードを実行して、<code>tidyverse</code>をインストールしてください。 <code>tidyverse</code>パッケージは，ある思想によって統一的なデザインで作成されたパッケージ群をインストールするものです。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-3_d291f8f4510293c4b2660ba69cf108ed">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>) <span class="co"># 最初の一回だけ実行</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>そして、以下のコードを実行して、<code>tidyverse</code>を読み込みます。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-4_781a9aba308c1bac76fbcb053b5aec3c">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="便利なパッケージ" class="slide level2">
<h2>便利なパッケージ</h2>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-5_47bb6c280d05fb81f505c11b66c9db9e">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">install.packages</span>(<span class="st">"bloom"</span>) <span class="co"># 結果の整形</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">install.packages</span>(<span class="st">"ggthemes"</span>) <span class="co"># グラフの見た目</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="fu">install.packages</span>(<span class="st">"modelsummary"</span>) <span class="co"># 回帰結果の作表</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="fu">install.packages</span>(<span class="st">"kableExtra"</span>) <span class="co"># 表の整形</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="fu">install.packages</span>(<span class="st">"gt"</span>) <span class="co"># 表の整形</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="fu">install.packages</span>(<span class="st">"patchwork"</span>) <span class="co"># グラフを並べて表示</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="githubとの連携" class="slide level2">
<h2>Githubとの連携</h2>
<ul>
<li>GitHubは、Gitというバージョン管理システムを使って、ソースコードのバージョン管理をクラウド上で行うことができる無料サービス</li>
<li>Visual Studio CodeはGit/GitHubとの連携も簡単</li>
<li>まずは、GitHubのウェブサイトにアクセスし、アカウントを作成してください。 <a href="https://github.com/">GitHub</a></li>
</ul>
</section>
<section id="githubの学習" class="slide level2">
<h2>Githubの学習</h2>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./img/github_book01.jpg"></p>
<figcaption>GitHubのオススメ本</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./img/github_book02.jpg"></p>
<figcaption>はじめてでもできるGitとGitHubの教科書</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./img/github_book03.jpg"></p>
<figcaption>わかばちゃんと学ぶGit使い方入門</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="github-copilotを使う" class="slide level2">
<h2>GitHub Copilotを使う</h2>
<ul>
<li>GitHub Copilotは、AIがコードの作成を支援してくれる超便利なツール</li>
<li>学生は無料で利用できるので、プログラミングを学習しようとしている人は、導入の検討をしてみてください。</li>
</ul>
<p><a href="https://copilot.github.com/">GitHub Copilot</a></p>
</section>
<section>
<section id="rによるデータ操作" class="title-slide slide level1 center">
<h1>Rによるデータ操作</h1>

</section>
<section id="到達度検証のための課題" class="slide level2">
<h2>到達度検証のための課題</h2>
<ol type="1">
<li>CSVファイル、Excelファイルを読み込んで、中身を確認する。</li>
<li>必要なデータの抽出、変数の追加、変数の選択を行い、分析に適した形に持っていける。(<code>filter()</code>、<code>mutate()</code>,<code>select()</code>, <code>arrange()</code>, <code>pivot_longer()</code>, <code>pivot_wider()</code>)</li>
<li>データ結合の種類を理解し、複数のデータを結合して、1つのデータフレームを作成する。(<code>bind_rows()</code>, <code>bind_cols()</code>, <code>left_join()</code>, <code>right_join()</code>, <code>inner_join()</code>, <code>full_join()</code>)</li>
</ol>
</section>
<section id="データの読み込み" class="slide level2">
<h2>データの読み込み</h2>
<ul>
<li>多くのプログラミング言語で、読み込むデータとして最も多いのが<em>CSV形式</em>のファイル</li>
<li>ファイルの拡張子は<code>.csv</code></li>
<li>CSVとは、<em>C</em>omma <em>S</em>eparated <em>V</em>aluesの略で、カンマで区切られたデータのこと</li>
</ul>
<pre><code>企業ID,決算年月,売上高
13,2020/03,1000
13,2021/03,1200
13,2022/03,1500
24,2020/03,2000
24,2021/03,2200</code></pre>
<p>値とコンマ<code>,</code>のみで構成されたファイルのため、余計な情報が入っておらず、またファイルサイズも小さく、加工が簡単なので、データのやり取りによく使われます。</p>
<!--
24,2022/03,2500
33,2020/03,3000
33,2021/03,3200
33,2022/03,3500
-->
</section>
<section id="基本関数" class="slide level2">
<h2>基本関数</h2>
<ul>
<li>松浦のウェブサイトにあるデータ<code>keshohin_2023.csv</code>を読み込む</li>
<li>Rの場合は、基本関数<code>read.csv()</code>を使って、URLを直接指定して読み込む</li>
<li>読み込んだデータを<code>df</code>という変数に代入する</li>
</ul>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<p><code>R</code>でcsvファイルを読み込む最もシンプルな方法は、基本関数<code>read.csv()</code>を用いて、ファイル名やファイルを参照するURLを直接指定することです。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-6_b40a5d130d5d9dd7f72b457b5dc29df8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"https://so-ichi.com/kesho_2023.csv"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>MS Excelの場合</strong></p>
</div>
<div class="callout-content">
<ol type="1">
<li>URL<code>https://so-ichi.com/kesho_2023.csv</code>をブラウザに入力してファイルをダウンロードし、任意の場所に保存</li>
<li>「ファイル」から「開く…」をクリックして、保存したCSVファイルを選択し「開く」をクリック</li>
</ol>
</div>
</div>
</div>
</section>
<section id="excelファイルの読み込み" class="slide level2">
<h2>Excelファイルの読み込み</h2>
<p>MS Excelのファイルは拡張子が<code>.xlsx</code>、古いMS Excelだと<code>.xls</code>です。 RでExcelファイルを読み込むときは、<code>read_excel</code>という関数を使います。 Excelファイルを用意するのが面倒なので、ここではこうやれば読み込めるよ、というコードだけ説明します。ファイル名は<code>hoge.xlsx</code>とします。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<p><code>R</code>でMS Excelのファイルを読み込むには、<code>readxl</code>パッケージの<code>read_excel()</code>関数を用います。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-7_22fb609e28164ca1f6f5c7b15845abfd">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>dfx <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">"hoge.xlsx"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>MS Excelの場合</strong></p>
</div>
<div class="callout-content">
<ol type="1">
<li>「ファイル」から「開く…」をクリックし、保存してあるExcelファイルを選択し「開く」をクリック</li>
</ol>
</div>
</div>
</div>
<p>MS Excelの問題点は、目的のデータがどのExcelファイルに入っていて、それがどこに保存されているのかを覚えておかないと、いちいちファイルを開いて探さないといけないことです。</p>
<p>Rだとソースコードを残すことができますので、 どこにあるファイルを読み込んで、そこに何が入っているのかをコメントで残しておくことができます。</p>
</section>
<section id="読み込んだデータの確認" class="slide level2">
<h2>読み込んだデータの確認</h2>
<p>MS Excelは読み込んだデータが画面上に表として表示されていますが、Rでは変数に代入しただけでは、画面には何も表示されません。 そこでデータの中身を確認する関数として、次のようなものがあります。</p>
<ul>
<li><code>head()</code> : 最初の数行を表示させる基本関数</li>
<li><code>str()</code> : データの構造を表示させる基本関数</li>
<li><code>glimpse()</code> : データの構造を表示させるdplyrパッケージの関数</li>
<li><code>names()</code> : 変数名を表示させる基本関数</li>
</ul>
<p>これらを使って、データの中身を確認し、データの形に適した処理方法を学ぶ必要があります。 以下では、<code>head()</code>関数を使って、データの最初の数行を表示させてから、<code>str()</code>関数でデータの中の変数とその型を確認します。</p>
<p>Excelは目視が中心ですが、見ただけでは、文字列なのか数なのかが分からないので、やはりデータの型は確認する必要があります。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-8_b0ca8ee2f9edc451896969e7446e3aa5">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">head</span>(df)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  code   name    term shubetsu ren  sales netincome month
1  641 資生堂 1985/11       10   1 371040     14526    12
2  641 資生堂 1986/11       10   1 375294     13632    12
3  641 資生堂 1987/11       10   1 378977      9014    12
4  641 資生堂 1988/11       10   1 401311      9515    12
5  641 資生堂 1989/03       10   1 130654      4265     4
6  641 資生堂 1990/03       10   1 456352     11362    12</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">str</span>(df)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   130 obs. of  8 variables:
 $ code     : int  641 641 641 641 641 641 641 641 641 641 ...
 $ name     : chr  "資生堂" "資生堂" "資生堂" "資生堂" ...
 $ term     : chr  "1985/11" "1986/11" "1987/11" "1988/11" ...
 $ shubetsu : int  10 10 10 10 10 10 10 10 10 10 ...
 $ ren      : int  1 1 1 1 1 1 1 1 1 1 ...
 $ sales    : int  371040 375294 378977 401311 130654 456352 517252 553299 561549 549178 ...
 $ netincome: int  14526 13632 9014 9515 4265 11362 15850 16011 13290 14668 ...
 $ month    : int  12 12 12 12 4 12 12 12 12 12 ...</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>MS Excelの場合</strong></p>
</div>
<div class="callout-content">
<p>画面を見て確認する。</p>
</div>
</div>
</div>
<p>このデータには，</p>
<ul>
<li><code>code</code> : 企業コード (文字列)</li>
<li><code>name</code> : 企業名 (文字列)</li>
<li><code>term</code> : 決算年月 (文字列)</li>
<li><code>shubetsu</code> : 会計基準の種類 (数値)</li>
<li><code>ren</code> : 連結か単体 (数値)</li>
<li><code>sales</code> : 売上高 (数値)</li>
<li><code>netincome</code> : 当期純利益 (数値)</li>
<li><code>month</code> : 決算月数 (数値)</li>
</ul>
<p>が入っています。</p>
</section>
<section id="データの整形" class="slide level2">
<h2>データの整形</h2>
<h3 id="データ操作の基礎">データ操作の基礎</h3>
<p>さあ面白くなってきました。 次はデータを操作していきます。 Rによるデータ操作では、<code>tidyverse</code>パッケージ群の<code>dplyr</code>パッケージが大活躍します。</p>
<p><code>dplyr</code>パッケージの関数の中でもよく使うものに次のようなものがあります。</p>
<ul>
<li><code>select()</code> : 変数を選択する</li>
<li><code>filter()</code> : データを抽出する</li>
<li><code>mutate()</code> : 変数を追加する</li>
<li><code>arrange()</code> : データを並び替える</li>
<li><code>summarise()</code> : データを集計する</li>
<li><code>group_by()</code> : データをグループ化する</li>
</ul>
<h3 id="パイプ演算子">パイプ演算子</h3>
<p>Rでソースコードを書く際に，理解しやすく，読みやすいコードにするために非常に便利なのが，パイプ演算子<code>%&gt;%</code>です。 パイプ演算子<code>%&gt;%</code>は，左側のオブジェクトを右側の関数の第一引数に渡すという処理を行います。 たとえば，</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-9_62a1749751dbfa2db793cddf3189270a">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">sqrt</span>()</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.732051</code></pre>
</div>
</div>
<p>と書くと，<code>sqrt(1 + 2)</code>と同じ意味になります。 たとえば，<code>rnorm()</code>関数を使って平均0，分散1の標準正規分から100個のデータを作りたいとします。 <code>rnorm()</code>関数は3つの引数を取ります。</p>
<ol type="1">
<li>データの個数</li>
<li>平均</li>
<li>標準偏差</li>
</ol>
<p>したがって，<code>rnorm(100, 0, 1)</code>と書くと，平均0，分散1の標準正規分布から100個のデータを取り出すことができます。 パイプ演算子を使うと，</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-10_6aff62ea22f41b97d1ab69a04a274376">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="dv">100</span> <span class="sc">%&gt;%</span> <span class="fu">rnorm</span>(<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] -1.3572553505 -0.7710737632 -0.6618599624 -0.7988408388  1.0090618543
  [6] -0.3340209277  0.0896193000 -0.9493523195 -0.7184733584  0.8432990507
 [11] -0.7044685529  0.1989936683  0.1327002721  0.7296222909  2.1343530120
 [16]  0.6069824654  1.3135631689 -0.0682697473  0.0795486352 -0.4865497909
 [21]  0.2793662569 -0.7318499328  1.9948081293 -0.5240042896  0.6693724106
 [26] -0.1373570576  0.3975494475 -1.1730883943  0.5804554912  2.0022448469
 [31] -1.1922907504  0.5263405922 -0.8672897422 -0.7023260588  0.9850621053
 [36] -1.1937999304  1.0510909486 -0.7409995833  1.4609294835  0.2603021735
 [41] -0.5999882475  0.0004803921  1.5092805619 -0.3160982542 -1.2363750464
 [46]  0.3284615757  0.5450226068  0.7219884196  0.2583883443  1.7591655239
 [51]  1.0704835073 -0.5982507043 -0.2333814875 -0.7108978513  2.0642714308
 [56] -0.5108413970  1.0622618395 -0.6484187888  0.1223635187 -0.9351548591
 [61]  1.4356191524  0.5092783644 -0.1540087426 -0.0735818383  1.5789669637
 [66] -1.4464017347 -1.2063420363 -0.4591683164  1.3615933190 -1.1620947816
 [71]  0.0186081714  0.9715703055  0.4629084237  0.2247816418 -1.1321945087
 [76]  1.1269195608 -0.3608907292 -0.2676031527  1.1731795574  1.2457239013
 [81] -0.1024710845 -0.8016963010  0.0278880220 -1.3034185402 -0.3291029627
 [86] -1.3772863846  1.1300791759  0.8917810987 -0.5398358405  0.4477120872
 [91]  1.8356142653  0.7915008872 -0.7114711412 -1.5891088971  0.0985616526
 [96]  0.8965806004  0.9400073499 -0.0633376656  0.1656677422 -1.7665200226</code></pre>
</div>
</div>
<p>となります。 これは<code>rnorm()</code>関数の第1引数がデータの個数なので，そこに<code>100</code>を渡しています。 ここで平均に値を渡したい場合を考えます。 <code>mean</code>引数は第2引数なので，パイプ演算子では自動で渡してくれません。 そこで<code>.</code>を使って渡す場所を指定してあげます。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-11_6c561e13f0d69b6135b9765cff31d48d">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="dv">100</span> <span class="sc">%&gt;%</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span>. , <span class="at">sd =</span> <span class="dv">1</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] 101.54154 101.42682  99.16352  99.33611 101.11846  99.04617  98.85759
  [8]  99.93556 100.87995  99.45036  99.57699  99.39648 100.15111 100.40291
 [15] 100.17771  98.56418 101.59425 100.94427  99.69069  99.97026  99.83996
 [22]  98.85857  99.84139 101.99454 100.72582 100.47747 100.11478  98.64631
 [29]  98.62543 100.54695 100.25609  99.69065 100.66338  99.70592 100.74064
 [36]  99.44869  99.35655 100.35448 101.88179  99.46124 101.34836  99.45882
 [43]  99.89461 100.87687  99.49584  98.95390  99.99676  99.93280  99.78675
 [50]  98.46170 100.22099 101.04299 100.44883 100.65190  99.35712 100.91358
 [57] 101.39737  99.36175 100.41494  99.87025  98.98592  99.95083  99.69378
 [64]  99.67338  98.85939  99.63679  99.05609  99.04185 100.91275 100.14250
 [71]  99.82527  99.72951 100.72688  99.01809 100.85382 101.06089 100.75543
 [78]  99.40094  99.20164  98.08326 101.39560 100.26022 100.51790  99.99096
 [85]  99.41935 100.51489 101.44580  98.89688  98.37876 100.64436  99.45143
 [92]  98.85579  99.76324 100.84385  99.95757  99.27428  97.54577 100.81094
 [99]  99.70464  99.52319</code></pre>
</div>
</div>
<p>これで平均100，標準偏差1の正規分布から100個のデータを取り出せました。</p>
<p>これだけだとパイプ演算子<code>%&gt;%</code>の便利さが伝わらないので，たとえば次のような処理を考えてみましょう。</p>
<ol type="1">
<li>2020年のデータを抜き出し，</li>
<li>売上高当期純利益率を計算し，</li>
<li>産業グループごとに平均を計算する</li>
<li>利益率が高い順番に並び替える</li>
</ol>
<p>をパイプ演算子を使って書くと，</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-12_a42cf20cdd85204b1feb2110d962bff9">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>    <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"2020"</span>) <span class="sc">%&gt;%</span> <span class="co"># 2020年のみ</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>    <span class="fu">mutate</span>( <span class="co"># 新しい変数を作成</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>        <span class="at">ratio =</span> netincome <span class="sc">/</span> sales <span class="co"># 売上高利益率</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>    <span class="fu">group_by</span>(sangyo) <span class="sc">%&gt;%</span> <span class="co"># 産業グループごとに</span></span>
<span id="cb19-7"><a href="#cb19-7"></a>    <span class="fu">summarise</span>( <span class="co"># 平均を計算</span></span>
<span id="cb19-8"><a href="#cb19-8"></a>        <span class="at">mean_ratio =</span> <span class="fu">mean</span>(ratio) <span class="co"># 利益率の平均</span></span>
<span id="cb19-9"><a href="#cb19-9"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb19-10"><a href="#cb19-10"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(mean_ratio)) <span class="co"># 利益率の高い順に並び替え</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>のように，上から順番に処理を実行し，次に渡す，というプロセスが分かりやすく，読みやすいコードができました。 コメントも残しておけば，後から見返したときにも分かりやすいですし，他人によんでもらうときも親切ですね。 したがって，以下ではパイプ演算子を駆使して，データ操作を行っていきます。</p>
<h3 class="unnumbered" id="新しい変数を作成する-mutate">新しい変数を作成する <code>mutate</code></h3>
<p>新しい変数を作成するには，<code>dplyr</code>パッケージの<code>mutate()</code>関数を使います。 先ほど読みこんだデータから，当期純利益を売上高で除して売上高当期純利益率を計算して，<code>ratio</code>という変数を作ってみましょう。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-13_01c602f1d1ce29357555e039bfc2d179">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>    <span class="fu">mutate</span>( <span class="co"># 新しい変数を作成</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>        <span class="at">ratio =</span> netincome <span class="sc">/</span> sales <span class="co"># 売上高利益率</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>        )</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>MS Excelの場合</strong></p>
</div>
<div class="callout-content">
<p><code>I1</code>のセルに変数名を表す<code>ratio</code>と入力する。 F列の<code>sale</code>とG列の<code>netincome</code>を使って，<code>I2</code>のセルに</p>
<p><code>= G2 / F2</code></p>
<p>とし，<code>I2</code>セルの右下の四角をダブルクリックすると，自動で下のセルにも同じ計算がコピーされる。</p>
</div>
</div>
</div>
<p>次に，ある変数の値に応じて異なる値をとる変数を作るには，<code>mutate()</code>関数と<code>ifelse()</code>関数を同時に使います。<code>ifelse()</code>関数は次のような引数を取ります。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-14_148f4efcdcbf0e39420f4e5b30370b3c">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">ifelse</span>(条件, 条件が真のときの値, 条件が偽のときの値)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>先ほど計算した売上高当期純利益率が5%以上ならば「高い」，そうでなければ「低い」という変数<code>highlow</code>を作ってみましょう。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-15_f4a5e969600aa7a14fa7ee68228f2b9d">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>    <span class="fu">mutate</span>( <span class="co"># 新しい変数を作成</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>        <span class="at">highlow =</span> <span class="fu">ifelse</span>(ratio <span class="sc">&gt;=</span> <span class="fl">0.05</span>, <span class="st">"高い"</span>, <span class="st">"低い"</span>) <span class="co"># 売上高利益率</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>        )</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>MS Excelの場合</strong></p>
</div>
<div class="callout-content">
<p><code>J1</code>セルに<code>highlow</code>と入力する。 <code>J2</code>セルに</p>
<p><code>= if(I2 &gt;= 0.05, "高い", "低い")</code></p>
<p>と入力し，<code>J2</code>セルの右下の四角をダブルクリックすると，自動で下のセルにも同じ計算がコピーされる。</p>
</div>
</div>
</div>
<p>Excelだとセルの移動や変数名の入力，計算式の入力，セルのコピーといった作業で，キーボードとマウスを行ったり来たりする必要があり，若干面倒です。</p>
<p>ついでに，<code>mutate()</code>関数を使って，長すぎる企業名を短くしてみます。 ここでは「ポーラ・オルビスホールディングス」を「ポーラ」と略してみます。 <code>mutate()</code>と<code>ifelse</code>を使って，<code>name</code>変数の値が「ポーラ・オルビスホールディング」ならば「ポーラ」という値をとる変数<code>name</code>上書きします。を作ってみましょう。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-16_e81df05ddf1a0f542579b58c20c89914">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>    <span class="fu">mutate</span>( <span class="co"># 新しい変数を作成</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>        <span class="at">name =</span> <span class="fu">ifelse</span>(</span>
<span id="cb23-4"><a href="#cb23-4"></a>            name <span class="sc">==</span> <span class="st">"ポーラ・オルビスホールディング"</span>, <span class="st">"ポーラ"</span>, name) <span class="co"># 企業名</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>        )</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<h3 class="unnumbered" id="データを抽出する-filter">データを抽出する <code>filter</code></h3>
<p>データを抽出するには，<code>dplyr</code>パッケージの<code>filter()</code>関数を使います。 <code>filter()</code>関数は，次のような引数を取ります。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-17_1690c874cb0f7c2241cbabf04aa6a4ee">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">filter</span>(データ, 条件)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>先ほど作成した<code>ratio2</code>が「高い」企業だけを抽出してみましょう。 <code>filter()</code>関数の中の条件は，<code>==</code>を使って，<code>"高い"</code>という文字列と一致するかどうかを確認しています。 ここでは，<code>highlow</code>変数の値が<code>"高い"</code>と一致する企業だけを抽出し，<code>df_high</code>という変数に代入しています。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-18_be9036285f8c1fa142f1d916a7717f3c">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>df_high <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>    <span class="fu">filter</span>(highlow <span class="sc">==</span> <span class="st">"高い"</span>) <span class="co"># 条件</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>MS Excelの場合</strong></p>
</div>
<div class="callout-content">
<p>highlow変数のあるJ列をクリックして枠を移動させ，上の「ホーム」メニューから「並び替えとフィルター」をクリックし，「フィルター」をクリックする。 すると，変数名highlowのヨコに漏斗のようなマークが出るので，それをクリックすると，記録されたデータの種類が出てくるので，「高い」だけにチェックが入った状態にする。</p>
</div>
</div>
</div>
<p>Excelのクリック回数が増えてきましたね。</p>
<p><code>filter()</code>関数の中で指定する条件は，</p>
<ul>
<li><code>==</code> : 一致する</li>
<li><code>!=</code> : 一致しない</li>
<li><code>&gt;=</code>や<code>&lt;=</code> : 以上や以下</li>
<li><code>&gt;</code>や<code>&lt;</code> : より大きいや小さい</li>
<li><code>%in%</code> : いずれかに一致する</li>
</ul>
<p>などがあります。またこれらの条件を組み合わせることもできます。 その場合は，以下のように<code>&amp;</code>や<code>|</code>を使います。</p>
<ul>
<li><code>&amp;</code> : かつ</li>
<li><code>|</code> : または</li>
</ul>
<p>たとえば，資生堂と花王を抽出したり，売上高当期純利益率が5%以上かつ売上高が1000億円以上の企業を抽出するには， 次のように書きます。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-19_a4f403b8ad05053a06290e5049b61709">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>df_shiseido_kao <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>    <span class="fu">filter</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"資生堂"</span>, <span class="st">"花王"</span>)) <span class="co"># 2社だけ抽出</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>df_high2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>    <span class="fu">filter</span>(ratio <span class="sc">&gt;=</span> <span class="fl">0.05</span> <span class="sc">&amp;</span> sales <span class="sc">&gt;=</span> <span class="dv">1000</span>) <span class="co"># 2条件を同時に満たす</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<h3 class="unnumbered" id="変数を選択する-select">変数を選択する <code>select</code></h3>
<p>データの中から必要な変数だけを選択するには，<code>dplyr</code>パッケージの<code>select()</code>関数を使います。 たとえば，先ほど作成した<code>df</code>から，企業コード，企業名，売上高当期純利益率の3つの変数だけを選択してみましょう。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-20_88c9433f00223bc72c76101d3d8f2221">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>df3 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>    <span class="fu">select</span>(code, name, ratio) <span class="co"># 3つの変数だけ選択</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>MS Excelの場合</strong></p>
</div>
<div class="callout-content">
<p>オリジナルのデータをコピーして，下のタブから別のシートを選択し，そこに貼り付ける。</p>
<p>貼り付けたデータから<code>code</code>と<code>name</code>と<code>ratio</code>以外の列を削除する。</p>
</div>
</div>
</div>
<p>MS Excelだと，不要なデータを削除するのが怖い作業で，必要になったときにまた元のデータを読み込まないといけないので，面倒ですし，ミスのもとです。</p>
<p><code>select()</code>関数の中で使えるものには，以下のようなものがあります。 とても便利なので，覚えておくとよいでしょう。</p>
<ul>
<li><code>-</code> : 除外する (<code>-ratio</code>とかくと<code>ratio</code>以外を選択)</li>
<li><code>:</code> : 連続する変数を選択 (<code>code:ren</code>と書くと<code>code</code>から<code>ren</code>までを選択)</li>
<li><code>starts_with()</code> : ある文字列で始まる変数を選択</li>
<li><code>ends_with()</code> : ある文字列で終わる変数を選択</li>
</ul>
<p>たとえば，<code>mutate()</code>で新しい変数を作る場合に，変数名に法則性をつけておけば，<code>starts_with()</code>を使って一気に変数を選択することができます。 たとえば，比率を表す変数は<code>ratio</code>で始まるように統一しておく，基準化した変数には<code>_K</code>を最後に付けておく，などです。</p>
<h3 class="unnumbered" id="データを並び替える-arrange">データを並び替える <code>arrange</code></h3>
<p>データを並び替えるには，<code>dplyr</code>パッケージの<code>arrange()</code>関数を使います。 たとえば，先ほど作成した<code>df</code>から，売上高当期純利益率を並び替えてみましょう。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-21_295fc4227162906f268016f5e10f2478">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>    <span class="fu">select</span>(name, ratio) <span class="sc">%&gt;%</span> <span class="co"># 2つの変数だけ選択</span></span>
<span id="cb28-3"><a href="#cb28-3"></a>    <span class="fu">arrange</span>(ratio) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4"></a>    <span class="fu">head</span>()</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    name       ratio
1 ポーラ -0.43495809
2 資生堂 -0.07576384
3 資生堂 -0.03859062
4 資生堂 -0.02166802
5 資生堂 -0.01384122
6 資生堂 -0.01266169</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>小さい順に並び替えられました。 大きい順にするには，<code>desc()</code>関数を使います。 ついでに<code>knitr</code>パッケージの<code>kabble()</code>関数で表を見やすく加工してみます。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Rの場合</strong></p>
</div>
<div class="callout-content">
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-22_6e2bcc17fbd33f9bff8bd1375a73ab30">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>    <span class="fu">select</span>(name, ratio) <span class="sc">%&gt;%</span> <span class="co"># 2つの変数だけ選択</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(ratio)) <span class="sc">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="co"># 先頭の10行</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="co"># 表をきれいに表示</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: right;">ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ポーラ</td>
<td style="text-align: right;">0.1110647</td>
</tr>
<tr class="even">
<td style="text-align: left;">花王</td>
<td style="text-align: right;">0.1019213</td>
</tr>
<tr class="odd">
<td style="text-align: left;">花王</td>
<td style="text-align: right;">0.0987028</td>
</tr>
<tr class="even">
<td style="text-align: left;">花王</td>
<td style="text-align: right;">0.0986613</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ユニ・チャーム</td>
<td style="text-align: right;">0.0929384</td>
</tr>
<tr class="even">
<td style="text-align: left;">花王</td>
<td style="text-align: right;">0.0912752</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ポーラ</td>
<td style="text-align: right;">0.0895507</td>
</tr>
<tr class="even">
<td style="text-align: left;">ユニ・チャーム</td>
<td style="text-align: right;">0.0891383</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ユニ・チャーム</td>
<td style="text-align: right;">0.0890311</td>
</tr>
<tr class="even">
<td style="text-align: left;">ユニ・チャーム</td>
<td style="text-align: right;">0.0869777</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<p>これでどの企業のどの年度の売上高当期純利益率が大きいのかが一目瞭然になりました。</p>
<p>MS Excelだと，</p>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>MS Excelの場合</strong></p>
</div>
<div class="callout-content">
<p>「ホーム」メニューから「並び替えとフィルター」をクリックし，「昇順」をクリックする。</p>
<p>必要なデータだけ選択してコピペすれば，表が完成します。</p>
</div>
</div>
</div>
<p>となります。 簡単ですが，MS Excelの並び替えは注意が必要で，並び替えた後にデータを追加すると，並び替えが解除されてしまい，元に戻せなくなったり，空列があると並び替えがうまくいかなかったりします。</p>
<h3 id="long形式とwide形式">long形式とwide形式</h3>
<p>人間には読みやすいけれどパソコンは読みにくい，というデータの形式があります。 例えば下の表を見てみましょう。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">地点</th>
<th style="text-align: center;">6時</th>
<th style="text-align: center;">12時</th>
<th style="text-align: center;">18時</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">札幌</td>
<td style="text-align: center;">12℃</td>
<td style="text-align: center;">15℃</td>
<td style="text-align: center;">13℃</td>
</tr>
<tr class="even">
<td style="text-align: center;">大阪</td>
<td style="text-align: center;">20℃</td>
<td style="text-align: center;">24℃</td>
<td style="text-align: center;">22℃</td>
</tr>
<tr class="odd">
<td style="text-align: center;">福岡</td>
<td style="text-align: center;">23℃</td>
<td style="text-align: center;">25℃</td>
<td style="text-align: center;">25℃</td>
</tr>
</tbody>
</table>
<p>このような形のデータをワイド形式(wide)といいます。 天気予報で見かけそうなこの表は，人間にとっては分かりやすいですが，実はコンピュータにとっては，分かりにくいものです。 コンピュータが理解しやすいデータとして表すなら，次のような表になります。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">地点</th>
<th style="text-align: center;">時間</th>
<th style="text-align: center;">気温(℃)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">札幌</td>
<td style="text-align: center;">6時</td>
<td style="text-align: center;">12</td>
</tr>
<tr class="even">
<td style="text-align: center;">札幌</td>
<td style="text-align: center;">12時</td>
<td style="text-align: center;">15</td>
</tr>
<tr class="odd">
<td style="text-align: center;">札幌</td>
<td style="text-align: center;">18時</td>
<td style="text-align: center;">13</td>
</tr>
<tr class="even">
<td style="text-align: center;">大阪</td>
<td style="text-align: center;">6時</td>
<td style="text-align: center;">20</td>
</tr>
<tr class="odd">
<td style="text-align: center;">大阪</td>
<td style="text-align: center;">12時</td>
<td style="text-align: center;">24</td>
</tr>
<tr class="even">
<td style="text-align: center;">大阪</td>
<td style="text-align: center;">18時</td>
<td style="text-align: center;">22</td>
</tr>
<tr class="odd">
<td style="text-align: center;">福岡</td>
<td style="text-align: center;">6時</td>
<td style="text-align: center;">23</td>
</tr>
<tr class="even">
<td style="text-align: center;">福岡</td>
<td style="text-align: center;">12時</td>
<td style="text-align: center;">25</td>
</tr>
<tr class="odd">
<td style="text-align: center;">福岡</td>
<td style="text-align: center;">18時</td>
<td style="text-align: center;">25</td>
</tr>
</tbody>
</table>
<p>このような形式のデータをロング型(long)といいます。 このロング型のうち，一定のルールに従って作成されたデータを<strong>整然データ(tidy data)</strong>といい，Rでは，この整然データを扱うことが多いです。</p>
<p>R神Hadley Wickham氏は，データの型を理解することを，データ分析の第一歩とし，その一貫として整然データという考え方を提唱しています。 整然データとは，次のような原則に従って構築されたデータのことです(Wickham, 2014) 参考<a href="https://id.fnshr.info/2017/01/09/tidy-data-intro/">https://id.fnshr.info/2017/01/09/tidy-data-intro/</a>。</p>
<ol type="1">
<li>個々の変数 (variable) が1つの列 (column) をなす。</li>
<li>個々の観測 (observation) が1つの行 (row) をなす。</li>
<li>個々の観測の構成単位の類型 (type of observational unit) が1つの表 (table) をなす。</li>
<li>個々の値 (value) が1つのセル (cell) をなす</li>
</ol>
<p>上の表は，地点，時間，天気，気温の4つの変数があり1つの列をつくっています(ルール1)。 大阪12時の天気は雨，気温は12℃といったように1つの行が1つの観測を表しています(ルール2)。 このデータには種類の異なる観測はない(ルール3)。 また，各セルには1つの値が入っています(ルール4)。 よって，これが整然データとなります。</p>
<p>上のロング型の天気データを使って，ロングからワイド，ワイドからロングの操作を学びましょう。</p>
<p>まずデータを作ります。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-23_12507264301d9190b0a8d8b1edea879c">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>df_weather <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb31-2"><a href="#cb31-2"></a>    <span class="at">place =</span> <span class="fu">c</span>(<span class="st">"札幌"</span>,<span class="st">"札幌"</span>,<span class="st">"札幌"</span>,<span class="st">"大阪"</span>,<span class="st">"大阪"</span>,<span class="st">"大阪"</span>,<span class="st">"福岡"</span>,<span class="st">"福岡"</span>,<span class="st">"福岡"</span>), <span class="co"># 各地を3個ずつ</span></span>
<span id="cb31-3"><a href="#cb31-3"></a>    <span class="at">time =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"6時"</span>, <span class="st">"12時"</span>, <span class="st">"18時"</span>),<span class="dv">3</span>),</span>
<span id="cb31-4"><a href="#cb31-4"></a>    <span class="at">temp =</span> <span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">15</span>,<span class="dv">13</span>,<span class="dv">20</span>,<span class="dv">24</span>,<span class="dv">22</span>,<span class="dv">23</span>,<span class="dv">25</span>,<span class="dv">25</span>)</span>
<span id="cb31-5"><a href="#cb31-5"></a>)</span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="fu">print</span>(df_weather)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  place time temp
1  札幌  6時   12
2  札幌 12時   15
3  札幌 18時   13
4  大阪  6時   20
5  大阪 12時   24
6  大阪 18時   22
7  福岡  6時   23
8  福岡 12時   25
9  福岡 18時   25</code></pre>
</div>
</div>
<p>これはロング型の整然データとなります。</p>
<h3 class="unnumbered" id="ロングからワイド-pivot_wider">ロングからワイド <code>pivot_wider</code></h3>
<p>Rで使うならこのままでよいのですが，あえてこれをワイド型に変えてみましょう。</p>
<p>教科書で使用されている<code>spread()</code>は「根本的に設計ミスってた」と公式で発表されているので，R神が作った<code>pivot_wider()</code>を使います。widerという名前の通り，ワイド型に変換する関数です。</p>
<p><code>pivot_wider()</code>の引数は，<code>names_from</code>と<code>values_from</code>です。<code>names_from</code>は，ワイド型に変換するときに，どの変数を列にするかを指定します。<code>values_from</code>は，ワイド型に変換するときに，どの変数の値を使うかを指定します。</p>
<p>以下のコードでは，<code>time</code>変数の値を列に，<code>temp</code>変数の値を値にして，<code>df_wide</code>という変数に代入しています。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-24_01d9ea6ee35f2b4f2771a7de8e7f3ac9">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>df_wide <span class="ot">&lt;-</span> df_weather <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> time, <span class="at">values_from =</span> temp)</span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="fu">print</span>(df_wide)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  place `6時` `12時` `18時`
  &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 札幌     12     15     13
2 大阪     20     24     22
3 福岡     23     25     25</code></pre>
</div>
</div>
<p>これでワイド型に変換できました。</p>
<h3 class="unnumbered" id="ワイドからロング-pivot_longer">ワイドからロング <code>pivot_longer</code></h3>
<p>次に，このワイド型のデータをロング型に変換してみます。 教科書では，<code>tidyr</code>の<code>gather()</code>を使っていますが，これも<code>wider()</code>と同じ問題を持っているので，R神による<code>pivot_longer()</code>を使います。</p>
<p><code>pivot_longer()</code>の引数は，<code>cols</code>と<code>names_to</code>と<code>values_to</code>です。</p>
<ul>
<li><code>cols</code>は，ロング型に変換するときに，どの変数を行にするかを指定</li>
<li><code>names_to</code>は，ロング型に変換するときに，どの変数の値を使うかを指定</li>
<li><code>values_to</code>は，ロング型に変換するときに，どの変数の値を使うかを指定</li>
</ul>
<p>以下のコードでは，<code>6時</code>，<code>12時</code>，<code>18時</code>の3つの変数を行に，<code>time</code>という変数の値を列に，<code>temp</code>という変数の値を値にして，<code>df_long</code>という変数に代入しています。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-25_b81314ff3a41fd044042bbae8d9053e8">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>df_long <span class="ot">&lt;-</span> df_wide <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb35-3"><a href="#cb35-3"></a>        <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"6時"</span>, <span class="st">"12時"</span>, <span class="st">"18時"</span>), <span class="co"># 縦にする変数</span></span>
<span id="cb35-4"><a href="#cb35-4"></a>        <span class="at">names_to =</span> <span class="st">"time"</span>, <span class="co"># 縦にした変数名</span></span>
<span id="cb35-5"><a href="#cb35-5"></a>        <span class="at">values_to =</span> <span class="st">"temp"</span>) <span class="co"># 値</span></span>
<span id="cb35-6"><a href="#cb35-6"></a><span class="fu">print</span>(df_long)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  place time   temp
  &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
1 札幌  6時      12
2 札幌  12時     15
3 札幌  18時     13
4 大阪  6時      20
5 大阪  12時     24
6 大阪  18時     22
7 福岡  6時      23
8 福岡  12時     25
9 福岡  18時     25</code></pre>
</div>
</div>
<p>元のロング型に戻りました。</p>
<h3 id="データの結合">データの結合</h3>
<p>別々のデータを結合させて使いたいことはよくあります。 例えば，次のようなデータを結合させる場合を考えてみましょう。</p>
<h4 class="unnumbered" id="表a">表A</h4>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: right;">term</th>
<th style="text-align: right;">sale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">トヨタ</td>
<td style="text-align: right;">2020</td>
<td style="text-align: right;">1000</td>
</tr>
<tr class="even">
<td style="text-align: left;">トヨタ</td>
<td style="text-align: right;">2021</td>
<td style="text-align: right;">900</td>
</tr>
<tr class="odd">
<td style="text-align: left;">トヨタ</td>
<td style="text-align: right;">2022</td>
<td style="text-align: right;">1400</td>
</tr>
<tr class="even">
<td style="text-align: left;">ホンダ</td>
<td style="text-align: right;">2020</td>
<td style="text-align: right;">800</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ホンダ</td>
<td style="text-align: right;">2021</td>
<td style="text-align: right;">700</td>
</tr>
<tr class="even">
<td style="text-align: left;">ホンダ</td>
<td style="text-align: right;">2022</td>
<td style="text-align: right;">900</td>
</tr>
</tbody>
</table>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-26_a0af33970a0a531540dd0c0f6eac00b4">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>df_A <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-2"><a href="#cb37-2"></a>    <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"トヨタ"</span>, <span class="st">"トヨタ"</span>, <span class="st">"トヨタ"</span>, <span class="st">"ホンダ"</span>, <span class="st">"ホンダ"</span>, <span class="st">"ホンダ"</span>),</span>
<span id="cb37-3"><a href="#cb37-3"></a>    <span class="at">term =</span> <span class="fu">c</span>(<span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>),</span>
<span id="cb37-4"><a href="#cb37-4"></a>    <span class="at">sale =</span> <span class="fu">c</span>(<span class="dv">1000</span>, <span class="dv">900</span>, <span class="dv">1400</span>, <span class="dv">800</span>, <span class="dv">700</span>, <span class="dv">900</span>)</span>
<span id="cb37-5"><a href="#cb37-5"></a>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<h4 class="unnumbered" id="表b">表B</h4>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: right;">term</th>
<th style="text-align: right;">sale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">日産</td>
<td style="text-align: right;">2020</td>
<td style="text-align: right;">400</td>
</tr>
<tr class="even">
<td style="text-align: left;">日産</td>
<td style="text-align: right;">2021</td>
<td style="text-align: right;">500</td>
</tr>
<tr class="odd">
<td style="text-align: left;">日産</td>
<td style="text-align: right;">2022</td>
<td style="text-align: right;">900</td>
</tr>
<tr class="even">
<td style="text-align: left;">マツダ</td>
<td style="text-align: right;">2020</td>
<td style="text-align: right;">300</td>
</tr>
<tr class="odd">
<td style="text-align: left;">マツダ</td>
<td style="text-align: right;">2021</td>
<td style="text-align: right;">400</td>
</tr>
<tr class="even">
<td style="text-align: left;">マツダ</td>
<td style="text-align: right;">2022</td>
<td style="text-align: right;">200</td>
</tr>
</tbody>
</table>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-27_fc6fc449c75af1ea8324cc83d60c5dcc">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>df_B <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb38-2"><a href="#cb38-2"></a>    <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"日産"</span>, <span class="st">"日産"</span>, <span class="st">"日産"</span>, <span class="st">"マツダ"</span>, <span class="st">"マツダ"</span>, <span class="st">"マツダ"</span>),</span>
<span id="cb38-3"><a href="#cb38-3"></a>    <span class="at">term =</span> <span class="fu">c</span>(<span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>),</span>
<span id="cb38-4"><a href="#cb38-4"></a>    <span class="at">sale =</span> <span class="fu">c</span>(<span class="dv">400</span>, <span class="dv">500</span>, <span class="dv">900</span>, <span class="dv">300</span>, <span class="dv">400</span>, <span class="dv">200</span>)</span>
<span id="cb38-5"><a href="#cb38-5"></a>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<h4 class="unnumbered" id="表c">表C</h4>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: right;">term</th>
<th style="text-align: right;">netincome</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">トヨタ</td>
<td style="text-align: right;">2020</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">トヨタ</td>
<td style="text-align: right;">2021</td>
<td style="text-align: right;">90</td>
</tr>
<tr class="odd">
<td style="text-align: left;">トヨタ</td>
<td style="text-align: right;">2022</td>
<td style="text-align: right;">150</td>
</tr>
<tr class="even">
<td style="text-align: left;">ホンダ</td>
<td style="text-align: right;">2020</td>
<td style="text-align: right;">140</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ホンダ</td>
<td style="text-align: right;">2021</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">ホンダ</td>
<td style="text-align: right;">2022</td>
<td style="text-align: right;">90</td>
</tr>
<tr class="odd">
<td style="text-align: left;">スバル</td>
<td style="text-align: right;">2020</td>
<td style="text-align: right;">30</td>
</tr>
<tr class="even">
<td style="text-align: left;">スバル</td>
<td style="text-align: right;">2021</td>
<td style="text-align: right;">35</td>
</tr>
<tr class="odd">
<td style="text-align: left;">スバル</td>
<td style="text-align: right;">2022</td>
<td style="text-align: right;">50</td>
</tr>
</tbody>
</table>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-28_516470d2a3ae3b497dbcb8824570e7f0">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>df_C <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb39-2"><a href="#cb39-2"></a>    <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"トヨタ"</span>, <span class="st">"トヨタ"</span>, <span class="st">"トヨタ"</span>, <span class="st">"ホンダ"</span>, <span class="st">"ホンダ"</span>, <span class="st">"ホンダ"</span>, <span class="st">"スバル"</span>, <span class="st">"スバル"</span>, <span class="st">"スバル"</span>),</span>
<span id="cb39-3"><a href="#cb39-3"></a>    <span class="at">term =</span> <span class="fu">c</span>(<span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>),</span>
<span id="cb39-4"><a href="#cb39-4"></a>    <span class="at">netincome =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">90</span>, <span class="dv">150</span>, <span class="dv">140</span>, <span class="dv">100</span>, <span class="dv">90</span>, <span class="dv">30</span>, <span class="dv">35</span>, <span class="dv">50</span>)</span>
<span id="cb39-5"><a href="#cb39-5"></a>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>この3つのデータを結合させる場合を考えます。 まず表Aと表Bは同じ変数をもつデータなので，これらを結合させるには，縦につなげる必要があります。 このような結合を<strong>縦結合</strong>とか連結といいます。 縦結合は，<code>dplyr</code>パッケージの<code>bind_rows()</code>関数を使います。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-29_3745ba5a7a63ef951ef531739e106b85">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>df_AB <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(df_A, df_B)</span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="fu">print</span>(df_AB)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     name term sale
1  トヨタ 2020 1000
2  トヨタ 2021  900
3  トヨタ 2022 1400
4  ホンダ 2020  800
5  ホンダ 2021  700
6  ホンダ 2022  900
7    日産 2020  400
8    日産 2021  500
9    日産 2022  900
10 マツダ 2020  300
11 マツダ 2021  400
12 マツダ 2022  200</code></pre>
</div>
</div>
<p>縦に結合できたので，トヨタ，ホンダ，日産，マツダのデータが入ったデータベース<code>df_AB</code>ができました。</p>
<p>次に，この<code>df_AB</code>と<code>df_C</code>を結合させます。 <code>df_C</code>は<code>netincome</code>という<code>df_AB</code>にはない変数があり，異なる変数をもつデータ同士の結合となります。 これらを結合させるには，横につなげる必要があります。 このような結合を<strong>結合</strong>といいます。</p>
<p>結合には，</p>
<ul>
<li><strong>内部結合</strong>(inner join)</li>
<li><strong>外部結合</strong>(outer join)</li>
</ul>
<p>があり，外部結合には，</p>
<ul>
<li><strong>完全結合</strong>(full join)</li>
<li><strong>左結合</strong>(left join)</li>
<li><strong>右結合</strong>(right join)</li>
</ul>
<p>があります。</p>
<p>内部結合は<strong>両方のデータベースに存在する観測値のみを保持</strong>するため，多くのデータが欠落することになりますが，<strong>外部結合</strong>は、少なくとも1つのテーブルに存在する観測値を保持するので，大部分のデータが欠落することにはなりません。</p>
<p>3つの外部結合の特徴は次の通りです。</p>
<ul>
<li><strong>完全結合</strong>は、xとyのすべての観測値を保持します。</li>
<li><strong>左結合</strong>は、xのすべての観測値を保持します。</li>
<li><strong>右結合</strong>は、yのすべての観測値を保持します。</li>
</ul>
<p>R神の神書籍<a href="https://r4ds.hadley.nz/">R for Data Science (2e)</a>の図がわかりやすいので，ここで紹介します。</p>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="img/R4D_join.png"></p>
<figcaption>外部結合の例</figcaption>
</figure>
</div>
<p>内部結合と3つの外部結合をベン図で表すとこうなります。</p>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="img/R4D_outer_join.png"></p>
<figcaption>外部結合のベン図</figcaption>
</figure>
</div>
<p>最もよく使われる結合は<strong>左結合</strong>です。 元データに他のデータを結合する場合，元データに含まれるデータのみ保持したい場合が多いので，追加データを調べるときはいつもこれを使います。 左結合はデフォルトの結合であるべきで、他の結合を選択する強い理由がない限り、これを使用します。</p>
<p>では，<code>df_AB</code>と<code>df_C</code>を左結合してみましょう。 結合する際にキーとなる変数を指定する必要があります。 ここでは<code>name</code>と<code>term</code>の2つの変数をキーとして指定します。 こうすることで，<code>name</code>と<code>term</code>が一致する観測値を結合します。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-30_471467c140bbccec0cbcf23d8a8eec79">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>df_left <span class="ot">&lt;-</span> df_AB <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>    <span class="fu">left_join</span>(df_C, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span>, <span class="st">"term"</span>))</span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="fu">print</span>(df_left)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     name term sale netincome
1  トヨタ 2020 1000       100
2  トヨタ 2021  900        90
3  トヨタ 2022 1400       150
4  ホンダ 2020  800       140
5  ホンダ 2021  700       100
6  ホンダ 2022  900        90
7    日産 2020  400        NA
8    日産 2021  500        NA
9    日産 2022  900        NA
10 マツダ 2020  300        NA
11 マツダ 2021  400        NA
12 マツダ 2022  200        NA</code></pre>
</div>
</div>
<p><code>df_AB</code>にはトヨタ，ホンダ，日産，マツダのデータがありますが，<code>df_C</code>には日産とマツダのデータがなく，スバルのデータがあります。 そのため左結合すると，日産とマツダの<code>netincome</code>には<code>NA</code>が入り，スバルは欠落します。</p>
<p><code>df_AB</code>と<code>df_C</code>を右結合してみましょう。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-31_7df7fdd0c08e7a5d82adef656467d4f6">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>df_right <span class="ot">&lt;-</span> df_AB <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>    <span class="fu">right_join</span>(df_C, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span>, <span class="st">"term"</span>))</span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="fu">print</span>(df_right)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    name term sale netincome
1 トヨタ 2020 1000       100
2 トヨタ 2021  900        90
3 トヨタ 2022 1400       150
4 ホンダ 2020  800       140
5 ホンダ 2021  700       100
6 ホンダ 2022  900        90
7 スバル 2020   NA        30
8 スバル 2021   NA        35
9 スバル 2022   NA        50</code></pre>
</div>
</div>
<p><code>df_C</code>には日産とマツダのデータがなく，トヨタとホンダとスバルのデータがあります。 そのため右結合すると日産とマツダのデータが欠落し，<code>df_C</code>に含まれていたトヨタ，ホンダ，スバルのデータが残ります。 しかしスバルの<code>sale</code>には<code>NA</code>が入ります。</p>
<p>最後に，<code>df_AB</code>と<code>df_C</code>を完全結合してみましょう。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-32_6f84fba7e73fa3a24afd83598c187d98">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>df_full <span class="ot">&lt;-</span> df_AB <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>    <span class="fu">full_join</span>(df_C, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span>, <span class="st">"term"</span>))</span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="fu">print</span>(df_full)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     name term sale netincome
1  トヨタ 2020 1000       100
2  トヨタ 2021  900        90
3  トヨタ 2022 1400       150
4  ホンダ 2020  800       140
5  ホンダ 2021  700       100
6  ホンダ 2022  900        90
7    日産 2020  400        NA
8    日産 2021  500        NA
9    日産 2022  900        NA
10 マツダ 2020  300        NA
11 マツダ 2021  400        NA
12 マツダ 2022  200        NA
13 スバル 2020   NA        30
14 スバル 2021   NA        35
15 スバル 2022   NA        50</code></pre>
</div>
</div>
<p><code>df_AB</code>にはトヨタ，ホンダ，日産，マツダのデータがありますが，<code>df_C</code>にはトヨタ，ホンダ，スバルのデータがあるため， 完全結合した<code>df_full</code>にはすべての企業のデータが入ります。 しかし，日産とマツダの<code>netincome</code>には<code>NA</code>が入り，スバルの<code>sale</code>にも<code>NA</code>が入ります。</p>
<p>このように，結合するデータによって，結合したデータに含まれるデータが変わるので，自分が望む結合後のデータの形を考えて，どの結合を使うかを選ぶ必要があります。</p>
<p>ついでに内部結合もやってみましょう。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-33_d4472674ae085ed3f7021ce23d709102">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>df_inner <span class="ot">&lt;-</span> df_AB <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>    <span class="fu">inner_join</span>(df_C, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span>, <span class="st">"term"</span>))</span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="fu">print</span>(df_inner)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    name term sale netincome
1 トヨタ 2020 1000       100
2 トヨタ 2021  900        90
3 トヨタ 2022 1400       150
4 ホンダ 2020  800       140
5 ホンダ 2021  700       100
6 ホンダ 2022  900        90</code></pre>
</div>
</div>
<p>予想どおり，両方のデータに含まれているトヨタとホンダだけが残り，片方のデータにしか含まれていない日産，マツダ，スバルのデータは欠落してしまいました。 このように内部結合は，両方のデータに存在する観測値のみを保持するため，多くのデータが欠落することになり，利用する機会があまりないです。</p>
</section>
<section id="データの保存" class="slide level2">
<h2>データの保存</h2>
<p>前処理が終わったデータは，ファイルとして保存しておくとよいでしょう。 たとえば，<code>df_left</code>を<code>df_left.csv</code>というファイル名で保存するには，<code>readr</code>パッケージの<code>write_csv()</code>関数を使います。</p>
<p><code>write_csv()</code>関数の第1引数は保存したいオブジェクト(ここでは<code>df_left</code>)で，あとの主要な引数は，</p>
<ul>
<li><code>file</code></li>
<li><code>na = "NA"</code></li>
<li><code>append = FALSE</code></li>
</ul>
<p>となります。 <code>file</code>は保存するファイル名を指定します。 <code>na</code>は欠損値をどうするかを指定します。デフォルトでは<code>NA</code>となっています。 <code>append</code>は，既存のファイルに追記するかどうかを指定します。基本は上書きなので，<code>FALSE</code>にしておきます。</p>
<div class="cell" data-hash="prezemi_2023_03_presen_cache/revealjs/unnamed-chunk-34_61b05d74a36f602559924de5be4dc317">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="fu">write_csv</span>(df_left, <span class="at">file =</span> <span class="st">"df_left.csv"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これで，作業ディレクトリに<code>df_left.csv</code>が保存されました。 分析を進める際は，このようにして保存したデータを読み込んで使います。</p>

<div class="footer footer-default">

</div>
</section></section>
    </div>
  </div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="site_libs/revealjs/plugin/search/search.js"></script>
  <script src="site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'smaller': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'convex',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button', {
        text: function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
      });
      clipboard.on('success', function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "コピーしました");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "コピーしました");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      });
      function tippyHover(el, contentFn) {
        const config = {
          allowHTML: true,
          content: contentFn,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        };
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          return note.innerHTML;
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>