---
title: |
  <b>プレゼミ2023</b> </br>
  <span style="color: #282A36; ">第10回 回帰分析</span>
author: "Soichi Matsuura"
format:
  revealjs:
    theme: ["default", "dracula.scss"]
    transition: convex
    slide-number: true
    chalkboard: true
    df_print: paged
    code-line-numbers: false
# highlight-style: "dracula"
highlight-style: github
execute:
  echo: true
  warning: false
---

## 今後のスケジュール

最終確認

- 12/04(月) 回帰分析 (11)
- 12/11(月) 回帰分析の応用 (12)
- 12/18(月) ロジスティック回帰分析 (13)
- 12/25(月) 休講
- 01/15(月) 因子分析 (14)
- 01/15(月) 因子分析の実践+α (15)


# 単回帰分析

::: columns
:::{.column width="50%"}

第10回講義の**到達目標**

- 回帰モデルを構築することができる。
- 回帰モデルを推定することができる。
- 結果を正しく理解し、解釈し、報告することができる。

:::
:::{.column width="50%"}

**到達度検証のための課題**

- 回帰モデルを作り、推定し、結果を出す。

:::
:::

## 準備

必要なパッケージと設定。無ければインストールする。

```{r}
knitr::opts_chunk$set(dev = "ragg_png")
library(tidyverse) # とりあえずこれ
library(ggthemes) # ggplot2のテーマ
library(knitr) # 作表
library(kableExtra) # 作表の拡張
library(scales) # 軸の単位を制御
library(modelsummary) # モデルのまとめ
theme_set(theme_few(base_size = 12))
update_geom_defaults("point", list(size = 3))
```

## データの読み込み

松浦のウェブサイトからデータ`adv_2023.csv`を読み込む。

```{r}
#| cache = TRUE
df <- read_csv("https://so-ichi.com/adv_2023.csv")
rmarkdown::paged_table(df, options = list(rows.print = 5, cols.print = 3))
```

## 変数

`adv_2023.csv`の中に含まれる変数

```{r}
names(df)
```

# 単回帰モデル

## 2変数間の関係

前回は売上高と広告宣伝費の関係を散布図(scatter diagram)と相関係数(correlation)を使って調べた。

```{r}
#| echo: FALSE
ggplot(df) + aes(x = 広告宣伝費, y = 売上高) + geom_point()
```

相関係数は`r round(cor(df$広告宣伝費, df$売上高), digits = 3)`と正の相関がある。


## 単回帰モデル

- **回帰モデル**(regression model)とは、**応答変数**$Y$を**説明変数**$X$の線形関数で表したモデルで、背後には$X \rightarrow Y$という**因果関係**(causality)があると仮定する。

- 相関係数は2変数間の**線形**関係を表す指標ではあるが、相関があるからといって**因果関係**(causality)があるとは限らない。

## 単回帰モデル

売上高を広告宣伝費で説明するモデルを考える。

```{mermaid}
%%| fig-width: 8.5
graph LR
A[広告宣伝費] --> B[売上高]
```

この因果関係を明らかにするため、売上高を応答変数$Y$、広告宣伝費を説明変数$X$として回帰モデルを構築する。

## 単回帰モデル

ここでは次のような線形モデルを構築する。

$$
Y_i = \beta _0 + \beta_1 X_i
$$

- $\beta_0$と$\beta_1$は**パラメータ**(定数)
- このモデルにしたがうと，$X_i$の値が決まれば、応答変数$Y$の値は一意に決まる。
- このようなモデルを**決定的モデル**(deterministic model)

## 単回帰モデル

現実には、広告宣伝費が同じでも売上高が異なることがある。
そこで売上高の水準が広告宣伝費だけで決まるのではなく、誤差$\varepsilon$を回帰モデルに加えたものを考える。

$$
Y_i = \beta _0 + \beta_1 X_i + \varepsilon_i
$$

<!-- 現実のデータで，1つの説明変数が応答変数を完全に説明できる(つまりモデル上にすべてのデータが載っている)ことはほとんどないため、 -->
- 確率変数である誤差項を含めたモデルを**確率モデル**(probabilistic model)という。
- ここでは$\varepsilon_i$が正規分布に従うと仮定する。

## 単回帰モデルの図

```{r}
#| echo: FALSE
x <- seq(-3, 3, length.out = 100) # 数列
y <- 0.5 * x + rnorm(100, 0, 1)
df_ols <- data.frame(x, y)
ggplot(df_ols, aes(x, y)) + geom_point() + geom_smooth(method = "lm")
```

## 単回帰モデルの仮定

この回帰モデルが意味をもつためには、誤差項$\varepsilon_i$が平均0で分散$\sigma^2$の正規分布に従うという仮定が必要です。

![図11.1](img/fig_11_1.png){width="60%"}

## 重回帰モデル

重回帰でも単回帰でも統計的推定は同じで、説明変数が1つか複数かの違いだけである。

$$
Y_i = \beta _0 + \beta_1 x_{i1} + \beta_2 x_{i2} + \cdots + \beta_p x_{ik} + \varepsilon_i
$$

この回帰係数$\beta$の推定値$b$を求めることが統計的推定となる。

## 重回帰モデル


企業の売上高は、前年度の広告宣伝費と研究開発費で説明できる、というモデルを考える。

$$
\text{売上高}_t = \beta_0 + \beta_1 \text{広告宣伝費}_{t-1} + \beta_2 \text{研究開発費}_{t-1} + \varepsilon_t
$$

## 重回帰モデルの推定

- 重回帰モデルを推定するには、基本関数の`lm()`を使う。
- 重回帰モデルの場合、複数の説明変数があるため`+`でつなげる

```{r}
res <- lm(売上高 ~ lag(研究開発費) + lag(広告宣伝費), data = df)
coef(res)
```

## 結果の解釈

上記の推定結果から、

$$
\text{売上高} = 0.00000 + 0.1716 \text{研究開発費}_{t-1} + 6.8131 \text{広告宣伝費}_{t-1}
$$

であることが分かった。



## 信頼区間と仮説検定


<!-- 先ほどの回帰係数の推定結果は，1サンプルからの結果であり，サンプルの数を増やせば推定値の分布ができるのは，単回帰分析と同じなので，ここでも同じ方法で信頼区間を求めることが出来ます。 -->
単回帰分析の場合，切片と回帰係数の2つが推定するパラメータなので，自由度が$n-2$の$t$分布を利用しました。
説明変数が$k$個ある重回帰分析の推定で利用する$t$分布の自由度は，$n-k-1$になります。
$100(1-\alpha)$％信頼区間は，

$$
b_m - t _{n-k-1, \frac{\alpha}{2}} SE(b_m) \leq \beta_m \leq b_m + t_{n-k-1, \frac{\alpha}{2}} SE(b_m)
$$

のように計算できる。

## 結果の解釈

先ほど推定した重回帰分析の結果を再度確認してみます。

```{r}
summary(res)
```

## 結果の解釈

ここから信頼区間を計算するためには，サンプルサイズ$n$と説明変数の数$k$から自由度$df = n - k -1$を求め，そのもとで特定の有意水準を設定して，関数`qt()`を使って$t$値を計算する。

先ほどの重回帰の例だと，サンプルサイズは`r nrow(df)`，説明変数の数は2なので，有意水準5％の両側検定を行う場合の$t$値は，
```{r}
n <- nrow(df) # サンプルサイズ
k <- 2 # 説明変数の数
freedom <- n - 2 - 1
p <- 0.025 # 両側5%なので片側2.5％
qt(p, freedom , lower.tail = F)
```

すると$t$値は，`r round(qt(p, freedom , lower.tail = F), digits = 4)`となる。

## 仮説検定 1

重回帰分析で検証したい仮説は，**説明変数が応答変数に影響を与えるか否か**ですが，複数の説明変数があるため，仮説には2つのパターンがあります。

**回帰係数のすべてがゼロである，という帰無仮説**

構築した回帰モデルの説明変数の中に，応答変数に影響を与えるものが1つもない，という仮説です。
$$
\begin{aligned}
H_0 : &\beta _1 = \beta _2 = \cdots = \beta_k = 0\\
H_A : &\beta _1 \not = 0 \text{ or } \beta _2 \not = 0 \text{ or } \cdots \text{ or } \beta _k \not = 0
\end{aligned}
$$

## 仮説検定 2

2つ目は，**回帰係数の中に少なくとも1つはゼロではない**，という帰無仮説である。

この仮説だと，個々の説明変数が応答変数に与える影響を別々に考え，説明変数ごとに回帰係数がゼロとなるかどうかを調べる。

$$
\begin{aligned}
H_{01}: \beta _1 &= 0, & H_{a1} : \beta _1 \not = 0 \\
H_{02}: \beta _1 &= 0, & H_{a2} : \beta _1 \not = 0 \\
\vdots \\
H_{0k}: \beta _k &= 0, & H_{ak} : \beta _k \not = 0 \\
\end{aligned}
$$

## 1つの仮説の検定

すべての回帰係数がゼロかどうかを検定するためには，**F分布**という確率分布を用います。
F分布の確率密度関数の導出は難しいのでここでは省略します
F分布の下で，自由度$n - k -1$で説明変数の数が$k$個であるときの検定統計量$F_0$は，次のように計算できます。

$$
\begin{aligned}
F_0 = \frac{R^2}{1 - R^2} \frac{n - k - 1}{k} = \displaystyle \frac{\sum (\hat y - \bar y)^2}{k} \div \frac{\sum e_i-2}{n - k - 1}
\end{aligned}
$$

ここで$R^2$は決定係数です。

## 1つの仮説の検定

この検定統計量$F_0$を用いたF検定の結果は，`lm()`関数で推定した結果の`summary()`関数で確認できます。

```{r}
summary(res)
```

## 1つの仮説の検定

- 結果の最後の行で`F-statistic:  9460 on 2 and 5171 DF,  p-value: < 2.2e-16`とあり，自由度2と5171のF分布で検定した結果，検定統計量$F_0$は9460であり，p値はほぼゼロとなった。
- つまり，帰無仮説である「すべての回帰係数がゼロ」は棄却され，少なくとも一つの回帰係数はゼロではない，という対立仮説が採択された。
- t分布と同様にF分布を用いた検定の臨界値は基本関数`qf()`で計算できる。

## 1つの仮説の検定

ここでは、サンプルサイズは`r nrow(df)`，説明変数の数は2なので，有意水準5％の両側検定を行う場合の$t$値は，
```{r}
p = 0.05
f1 <- 2
f2 <- 28440
qf(p,f1,f2,lower.tail =F)
```
となり，`r round(qf(p,f1,f2,lower.tail =F), digits =4)`という臨界値が得られた。
先ほどの推定結果からF値が9460と，臨界値を遙かに超える値であったため，帰無仮説は棄却された。


## 回帰係数の個別的検定

第2の仮説のパターンである個々の回帰係数の検定について考えてみる。
売上高を研究開発費と広告宣伝費で説明しようとした重回帰モデルだと，次の2つの仮説を検定することになる。

$$
\begin{aligned}
\text{研究開発費} H_{01} : \beta_1 = 0, & H_{a1} : \beta_1 \not = 0 \\
\text{広告宣伝費} H_{02} : \beta_1 = 0, & H_{a2} : \beta_1 \not = 0
\end{aligned}
$$

## 回帰係数の個別的検定

回帰係数の個別的検定は，単回帰分析と同様にt検定を用いる。
分析結果を`summary()`関数で確認する。

```{r}
summary(res)
```

## 結果の見方

- `Coefficients`の出力結果に，各説明変数の回帰係数の推定値`Estimate`と標準誤差`Std. Error`，t値`t value`，p値`Pr(>|t|)`が表示
- p値が設定した有意水準より小さい場合，その回帰係数がゼロであるという帰無仮説が棄却され，説明変数が応答変数に影響を与えている，という対立仮説が採択
- すべての回帰係数がゼロであるという帰無仮説を検証するF検定で，帰無仮説が棄却されたとしても，個別の回帰係数の検定で，すべての検定で帰無仮説を棄却できない，というケースも起こりうる。
- このような結果が出たときは，説明変数どうしの相関が強いときに生じやすいので注意


## 重回帰分析の結果のまとめ方

重回帰分析の結果を論文などに掲載する場合には，ほぼ決まったフォーマットがあるため，それに従って結果をまとめる。
ここでは超便利パッケージ`modelsummary`を使う。

```{r}
#| output-location: slide
library(modelsummary)
library(gt)
msummary(res,
  stars = TRUE, # p値の有意性を星で表示する
  fmt = '%.2f', # 小数点以下2桁で表示
  gof_omit = "AIC|BIC|Log.Lik." # いらない統計量
)
```


## まとめ

- 観測値とモデルとの差を表す確率変数である誤差項を含んだ確率的回帰モデルを考える。
- 誤差項は平均ゼロの正規分布にしたがう確率変数であると仮定
- 回帰分析の目的は係数$\beta_m$の推定値$b_m$の値を求めること
- 推定値$b_m$は標本ごとに異なる値で分布する。推定値の信頼区間を求めて推定の不確実性を評価
- 重回帰モデルの仮説検定は2種類:**すべての回帰係数がゼロである**と**個々の回帰係数がゼロである**、がある。前者には**F検定**，後者には**t検定**を用いる。

